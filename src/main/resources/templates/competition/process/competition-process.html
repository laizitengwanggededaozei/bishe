<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head th:replace="common/competition-common :: common_head(${myLinks}, ${myScripts})">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>参与比赛</title>
</head>
<body>
<div th:replace="common/competition-common::mall-header"></div>
<div th:replace="common/competition-common::competition-sidebar"></div>

<div class="com-body">
    <div class="com-title">参与比赛 - <span th:text="${matchDTO.matchName}">比赛名称</span></div>

    <div class="alert alert-info">
        <strong>比赛时间：</strong>
        <span th:text="${matchDTO.matchStartTime} + ' 至 ' + ${matchDTO.matchEndTime}"></span>
        <div class="team-info mt-2 fw-bold"></div>
    </div>

    <!-- 团队选择弹窗 -->
    <div class="modal fade" id="teamSelectModal" tabindex="-1" aria-labelledby="teamSelectModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="teamSelectModalLabel">选择参赛团队</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div th:if="${teams.size() == 0}">
                        <p>您目前没有符合条件的团队，请先 <a href="/team/create">创建团队</a> 并报名参赛。</p>
                    </div>
                    <div th:if="${teams.size() > 0}">
                        <form id="teamSelectForm">
                            <div class="form-group">
                                <label for="teamSelect">可用团队：</label>
                                <select class="form-control" id="teamSelect">
                                    <option value="">-- 请选择团队 --</option>
                                    <option th:each="team : ${teams}" th:value="${team.id}" th:text="${team.tname}">团队名称</option>
                                </select>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="confirmTeamBtn" disabled>确认选择</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 题目列表（初始隐藏） -->
    <div class="card mt-4 problem-list-container d-none">
        <div class="card-header">
            <h4>题目列表</h4>
        </div>
        <div class="card-body">
            <div th:if="${problems.size() == 0}">
                <p>当前比赛暂无题目</p>
            </div>
            <div th:if="${problems.size() > 0}">
                <div class="list-group">
                    <a th:each="problem : ${problems}" th:href="'/competition-process/problem/' + ${problem.problemId}" class="list-group-item list-group-item-action">
                        <div class="d-flex w-100 justify-content-between">
                            <h5 class="mb-1" th:text="${problem.title}">题目标题</h5>
                            <small th:text="${problem.type}">类型</small>
                        </div>
                        <p class="mb-1" th:text="${#strings.abbreviate(problem.content, 100)}">题目内容预览...</p>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- 操作按钮区域 -->
    <div class="card mt-4">
        <div class="card-header">
            <h4>操作</h4>
        </div>
        <div class="card-body">
            <div class="row" th:with="userRole=${session.loggedUser.id.substring(0, 1)}">
                <!-- 学生操作 -->
                <div class="col-md-4" th:if="${userRole == 'S'}">
                    <button class="btn btn-primary btn-block" data-bs-toggle="modal" data-bs-target="#teamSelectModal">选择团队</button>
                    <button class="btn btn-info btn-block view-submissions-btn mt-2" disabled>查看提交记录</button>
                </div>
                <div class="col-md-4">
                    <button class="btn btn-success btn-block view-results-btn" onclick="location.href='/competition-process/results?matchId=' + [[${matchDTO.matchId}]]">查看比赛结果</button>
                </div>

                <!-- 教师操作 -->
                <div class="col-md-4" th:if="${userRole == 'T'}">
                    <button class="btn btn-warning btn-block" onclick="location.href='/competition-process/evaluations?matchId=' + [[${matchDTO.matchId}]]">评审作品</button>
                </div>

                <!-- 组织者操作 -->
                <div class="col-md-4" th:if="${userRole == 'B'}">
                    <form th:action="@{/competition-process/generate-results}" method="post">
                        <input type="hidden" name="matchId" th:value="${matchDTO.matchId}">
                        <button type="submit" class="btn btn-warning btn-block">生成比赛结果</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<div th:replace="common/competition-common::mall-footer"></div>

<!-- 修改团队选择相关JavaScript部分 -->
<script>
    $(document).ready(function() {
        // 获取服务器端的选择的团队信息
        const userMatchTeams = [[${session.userMatchTeams}]];
        const matchId = [[${matchDTO.matchId}]];
        const key = "match_" + matchId;

        if (userMatchTeams && userMatchTeams[key]) {
            // 已有团队选择，自动加载
            const teamId = userMatchTeams[key];
            const selectedTeam = findTeamById(teamId);
            if (selectedTeam) {
                displaySelectedTeam(selectedTeam);
            }
        } else {
            // 无选择，显示团队选择对话框
            const teams = [[${teams}]];
            if (teams && teams.length === 1) {
                // 只有一个团队，自动选择
                selectTeam(teams[0].id);
            } else if (teams && teams.length > 1) {
                $('#teamSelectModal').modal('show');
            }
        }

        // 确认团队按钮点击事件
        $('#confirmTeamBtn').click(function() {
            const teamId = $('#teamSelect').val();
            if (teamId) {
                selectTeam(teamId);
            }
        });

        // 团队选择变更事件
        $('#teamSelect').change(function() {
            const teamId = $(this).val();
            $('#confirmTeamBtn').prop('disabled', !teamId);
        });
    });

    // 查找团队
    function findTeamById(teamId) {
        const teams = [[${teams}]];
        return teams.find(team => team.id == teamId);
    }

    // 显示已选择团队
    function displaySelectedTeam(team) {
        $('.team-info').text('当前参赛团队: ' + team.tname);
        $('.problem-list-container').removeClass('d-none');
        $('.view-submissions-btn').prop('disabled', false);
        $('.view-submissions-btn').click(function() {
            location.href = '/competition-process/submissions?teamId=' + team.id + '&matchId=' + [[${matchDTO.matchId}]];
        });
    }

    // 选择团队函数，发送到后端
    function selectTeam(teamId) {
        $.ajax({
            url: '/competition-process/select-team',
            type: 'POST',
            data: {
                teamId: teamId,
                matchId: [[${matchDTO.matchId}]]
            },
            success: function(response) {
                if (response.success) {
                    // 更新UI
                    $('.team-info').text('当前参赛团队: ' + response.teamName);
                    $('.problem-list-container').removeClass('d-none');
                    $('.view-submissions-btn').prop('disabled', false);
                    $('.view-submissions-btn').click(function() {
                        location.href = '/competition-process/submissions?teamId=' + teamId + '&matchId=' + [[${matchDTO.matchId}]];
                    });

                    // 关闭模态框
                    $('#teamSelectModal').modal('hide');
                } else {
                    alert(response.message || '选择团队失败');
                }
            },
            error: function() {
                alert('服务器错误，请稍后重试');
            }
        });
    }
</script>

</body>
</html>